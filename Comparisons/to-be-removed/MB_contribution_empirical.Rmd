---
title: "MB_contribution_empirical"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE, error = FALSE, comment="", fig.align = "center" ) 
library(ggplot2)
library(gridExtra)
library(readr)
library(tidyr)
library(gghalves)
library(dplyr)
library(cowplot)
library(lme4)
library(R.matlab)
source("/Users/sershadmanesh/Nextcloud/Drug_study/Public/accessory/input_mixedreg_MBcont_accessor.R")
source("/Users/sershadmanesh/Nextcloud/Drug_study/Public/plot/compare_mbmf_reg_plot.R")
```

```{r}
taskdrug = readRDS("/Users/sershadmanesh/Nextcloud/Drug_study/Public/data/taskdrug2.rds") # the data including unchosen options
drug = readRDS("/Users/sershadmanesh/Nextcloud/Drug_study/Public/data/drug.rds")
nsub=30
```

```{r}
# a theme for plots
thsara =theme(axis.title.y = element_text(hjust = 0.5, size = 16),
          axis.title.x = element_text(size = 16),
          axis.text = element_text(size = 14),
            axis.line = element_line(colour = "black"),
            panel.border = element_blank(),
            panel.grid = element_blank(),
            panel.background = element_blank(),
            legend.position = "right",
            legend.background=element_blank()
      )
```

```{r,fig.width = 1,fig.height = 1}
nsub= 30
ndrug=3
randeff = array(0, dim = c(ndrug, nsub))

for (dru in 1:ndrug){ # take care!!
C_MB=c()
U_MB=c()
Y_MB=c()
SS_MB=c()
P_MB=c()
 for (sub in 1:nsub){
    drugpos = drug[sub,dru] 
    
    tasksub = taskdrug[which(taskdrug$subject==sub & taskdrug$day==drugpos), ] # subj for new 4 subjects!!!attention
  
    realized_reward = cbind(tasksub$reward.1, tasksub$reward.2, tasksub$reward.3, tasksub$reward.4)
    reward_prob= cbind(tasksub$prob.1, tasksub$prob.2, tasksub$prob.3, tasksub$prob.4)
    trials= cbind(tasksub$trials.1, tasksub$trials.2)
    chosen = tasksub$choice
    score = tasksub$score
 
  ###preparing the input of mixed effect regression
      #confidence is not important for our MB contribution
    retreg = input_mixedreg_MBcont_accessor(chosen, score, sub, realized_reward, reward_prob, trials)
    
    Y_MB= c(Y_MB,retreg[[1]])
    C_MB= c(C_MB,retreg[[2]])
    SS_MB= c(SS_MB,retreg[[3]])
    P_MB= c(P_MB,retreg[[4]])
 } # sub
    N_MB= 1+rep(0,length(C_MB))
    prop = Y_MB/N_MB
    prop[which(N_MB==0)]=0
  
  MB_tbl_with_conf= data.frame(Y_MB, C_MB, SS_MB, P_MB, N_MB, prop)

  fitmix = glmer(prop ~  C_MB*P_MB+(C_MB*P_MB|SS_MB), data = MB_tbl_with_conf, weights = N_MB, family= binomial)
                
  f = summary(fitmix)
  randeff[dru,] =  f$coefficients[2,1] + ranef(fitmix)$SS_MB[,2]  # random effect + fixed effect
} # dru

```

```{r}
### Anova to compare Betas, influence of regressors, between drug conditions
randof = apply(randeff,c(1,3), mean)
nsub=30
subs = c(1:nsub)
tot_2opt = c(randof[1,subs],randof[2,subs],randof[3,subs])
drugname = c(rep("p", nsub), rep("d", nsub), rep("pl", nsub))
meta = data.frame(tot_2opt,drugname = as.factor(drugname) )
aov(tot_2opt~drugname , data = meta) %>% summary() 
kruskal.test(tot_2opt~drugname , data = meta) 
```

```{r}
# three column plot
effectmb= data.frame(randof[1,subs],randof[2,subs],randof[3,subs])
p2 = compare_mbmf_reg_plot(effectmb)
p2
```
